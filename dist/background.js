chrome.contextMenus.create({id:"saveVocab",title:"Save Word to Flashcards",contexts:["selection"]}),chrome.contextMenus.onClicked.addListener((e=>{"saveVocab"===e.menuItemId&&e.selectionText&&saveVocabulary(e.selectionText,"Context not provided","Reading unavailable")})),chrome.runtime.onMessage.addListener(((e,o,t)=>{if("saveVocabulary"===e.action)saveVocabulary(e.text,"Context not provided","Reading unavailable",e.wordInfo);else if("lookupWord"===e.action)return handleWordLookup(e,o,t),!0}));let connectionAttempts=0;const MAX_RECONNECT_ATTEMPTS=3;async function handleWordLookup(e,o,t){try{const o=await fetch(`https://jisho.org/api/v1/search/words?keyword=${encodeURIComponent(e.word)}`,{method:"GET",headers:{Accept:"application/json","User-Agent":"YomiSaver-Extension"}});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();t({success:!0,data:n}),connectionAttempts=0}catch(n){console.error("Proxy fetch error:",n),connectionAttempts<MAX_RECONNECT_ATTEMPTS?(connectionAttempts++,setTimeout((()=>handleWordLookup(e,o,t)),1e3)):t({success:!1,error:n.message})}}function saveVocabulary(e,o,t,n){console.log("Saving vocabulary:",{word:e,sentence:o,reading:t,wordInfo:n}),chrome.storage.local.get({vocabList:[]},(a=>{const s=a.vocabList||[],c={word:e,sentence:n?.sentence||o,reading:n?.reading||t,wordInfo:{reading:n?.reading||t,meanings:n?.meanings||[],jlpt:n?.jlpt||[],sentence:n?.sentence||o},timestamp:Date.now()};console.log("New entry:",c),s.some((o=>o.word===e))||(s.push(c),chrome.storage.local.set({vocabList:s},(()=>{console.log("Vocabulary saved:",c),chrome.runtime.sendMessage({action:"vocabUpdated",entry:c})})))}))}chrome.runtime.onStartup.addListener((()=>{connectionAttempts=0}));