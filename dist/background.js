chrome.contextMenus.create({id:"saveVocab",title:"Save Word to Flashcards",contexts:["selection"]}),chrome.contextMenus.onClicked.addListener((e=>{"saveVocab"===e.menuItemId&&e.selectionText&&saveVocabulary(e.selectionText,"Context not provided","Reading unavailable")})),chrome.runtime.onMessage.addListener(((e,o,t)=>{if("saveVocabulary"===e.action)saveVocabulary(e.text,"Context not provided","Reading unavailable",e.wordInfo);else if("lookupWord"===e.action)return handleWordLookup(e,o,t),!0}));let connectionAttempts=0;const MAX_RECONNECT_ATTEMPTS=3;async function handleWordLookup(e,o,t){const n=e.language||"en";try{const o="fr"===n?`https://jisho.org/api/v1/search/fr/words?keyword=${encodeURIComponent(e.word)}`:`https://jisho.org/api/v1/search/words?keyword=${encodeURIComponent(e.word)}`,a=await fetch(o,{method:"GET",headers:{Accept:"application/json","User-Agent":"YomiSaver-Extension"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.json();t({success:!0,data:s}),connectionAttempts=0}catch(n){console.error("Proxy fetch error:",n),connectionAttempts<MAX_RECONNECT_ATTEMPTS?(connectionAttempts++,setTimeout((()=>handleWordLookup(e,o,t)),1e3)):t({success:!1,error:n.message})}}function saveVocabulary(e,o,t,n){console.log("Saving vocabulary:",{word:e,sentence:o,reading:t,wordInfo:n}),chrome.storage.local.get({vocabList:[]},(a=>{const s=a.vocabList||[],r={word:e,sentence:n?.sentence||o,reading:n?.reading||t,wordInfo:{reading:n?.reading||t,meanings:n?.meanings||[],jlpt:n?.jlpt||[],sentence:n?.sentence||o},timestamp:Date.now()};console.log("New entry:",r),s.some((o=>o.word===e))||(s.push(r),chrome.storage.local.set({vocabList:s},(()=>{console.log("Vocabulary saved:",r),chrome.runtime.sendMessage({action:"vocabUpdated",entry:r})})))}))}chrome.runtime.onStartup.addListener((()=>{connectionAttempts=0}));